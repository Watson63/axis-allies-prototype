<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Axis & Allies Prototype - Battle System</title>
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #e6e6e6; text-align: center; margin: 0; padding: 0; }
    #board { display: grid; grid-template-columns: repeat(5, 100px); gap: 8px; padding: 20px; justify-content: center; }
    .territory { background: white; border: 2px solid #333; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; cursor: pointer; }
    .territory.selected { border-color: #007bff; box-shadow: 0 0 10px rgba(0,0,255,0.5); }
    .unit { font-size: 11px; padding: 4px 6px; border-radius: 4px; margin: 3px 0; color: white; font-weight: bold; }
    .battle-log { background: white; padding: 10px; margin: 10px auto; border-radius: 8px; width: 60%; }
    .dice { width: 30px; height: 30px; background: #fff; border: 2px solid #333; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin: 5px; border-radius: 4px; transition: transform 0.3s ease; }
    .rolling { transform: rotate(360deg); }
    button { padding: 6px 10px; margin: 6px; border-radius: 6px; cursor: pointer; background: #333; color: white; border: none; }
    button:hover { background: #555; }
  </style>
</head>
<body>
<div id="app">
  <div v-if="!user">
    <h2>Login</h2>
    <input v-model="email" placeholder="Email"><br>
    <input v-model="password" type="password" placeholder="Password"><br>
    <button @click="login">Login / Register</button>
  </div>

  <div v-else>
    <h2>Welcome, {{ user.email }}</h2>
    <div id="board">
      <div
        v-for="id in territoryOrder"
        :key="id"
        class="territory"
        :class="{ selected: selected && selected.from === id }"
        @click="handleTerritoryClick(id)"
      >
        <strong>{{ id }}</strong>
        <div 
          v-for="u in map[id]?.units || []" 
          :key="u.id" 
          class="unit"
          :style="{ backgroundColor: u.color || '#999' }"
        >
          {{ u.type }}
        </div>
      </div>
    </div>

    <div v-if="battle.active" class="battle-log">
      <h3>Battle in {{ battle.location }}</h3>
      <div>
        <button v-if="battle.phase==='attack' && !rolling" @click="rollDice('attack')">Roll Attack Dice</button>
        <button v-if="battle.phase==='defend' && !rolling" @click="rollDice('defend')">Roll Defense Dice</button>
      </div>

      <div>
        <div v-for="(d,i) in dice" :key="i" class="dice" :class="{ rolling: rolling }">{{ d }}</div>
      </div>

      <div v-if="battle.log.length">
        <h4>Combat Log</h4>
        <div v-for="(l, i) in battle.log" :key="i">{{ l }}</div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL4FGAaOfKPJfEkYGBUZN7dW5_XNfmoww",
  authDomain: "axisandallies-prototype.firebaseapp.com",
  projectId: "axisandallies-prototype",
  storageBucket: "axisandallies-prototype.firebasestorage.app",
  messagingSenderId: "663070828047",
  appId: "1:663070828047:web:9f37c0fc5541ff86d6657a"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function colorForUser(email) {
  const colors = ["#fcba03", "#fc0303", "#2403fc", "#1f8f03", "#000000"];
  let hash = 0;
  for (let i = 0; i < email.length; i++) hash = email.charCodeAt(i) + ((hash << 5) - hash);
  return colors[Math.abs(hash) % colors.length];
}

const app = Vue.createApp({
  data() {
    return {
      user: null,
      email: '',
      password: '',
      map: {},
      selected: null,
      battle: { active: false, location: '', attackers: [], defenders: [], phase: 'attack', log: [] },
      dice: [],
      rolling: false,
      territoryOrder: ["A","B","C","D","E","F","G","H","I","J"]
    };
  },
  methods: {
    async login() {
      try {
        await auth.signInWithEmailAndPassword(this.email, this.password);
      } catch {
        await auth.createUserWithEmailAndPassword(this.email, this.password);
      }
    },

    async handleTerritoryClick(id) {
      const ref = db.doc("games/demoGame");
      const snap = await ref.get();
      const data = snap.data();

      if (this.selected) {
        const fromId = this.selected.from;
        const unit = this.selected.unit;

        const defenderPresent = data.map[id].units.some(u => u.owner !== this.user.email);
        if (defenderPresent) {
          // start battle
          this.battle = {
            active: true,
            location: id,
            attackers: [unit],
            defenders: data.map[id].units,
            phase: 'attack',
            log: [`Battle starts in ${id}!`]
          };
          this.selected = null;
          return;
        }

        data.map[fromId].units = data.map[fromId].units.filter(u => u.id !== unit.id);
        data.map[id].units.push(unit);
        this.selected = null;
        await ref.update({ map: data.map });
      } else {
        const territory = data.map[id];
        const ownUnit = territory.units.find(u => u.owner === this.user.email);
        if (ownUnit) this.selected = { from: id, unit: ownUnit };
        else {
          const newUnit = {
            id: Date.now(),
            type: "infantry",
            owner: this.user.email,
            color: colorForUser(this.user.email)
          };
          territory.units.push(newUnit);
          await ref.update({ map: data.map });
        }
      }
    },

    async rollDice(role) {
      this.rolling = true;
      this.dice = Array.from({length: role === 'attack' ? this.battle.attackers.length : this.battle.defenders.length}, () => Math.ceil(Math.random() * 6));
      await new Promise(r => setTimeout(r, 1000));
      this.rolling = false;

      const hits = this.dice.filter(v => (role === 'attack' ? v === 1 : v <= 2)).length;
      this.battle.log.push(`${role} rolled: ${this.dice.join(', ')} â€” ${hits} hit(s)`);

      if (role === 'attack') {
        // defenders fire back next
        this.battle.phase = 'defend';
        this.battle.tempHits = hits;
      } else {
        // defenders get one final fire back
        const defenderHits = hits;
        const attackHits = this.battle.tempHits || 0;

        const aLosses = Math.min(defenderHits, this.battle.attackers.length);
        const dLosses = Math.min(attackHits, this.battle.defenders.length);

        this.battle.attackers.splice(0, aLosses);
        this.battle.defenders.splice(0, dLosses);
        this.battle.log.push(`Attackers lost ${aLosses}, Defenders lost ${dLosses}`);

        if (this.battle.attackers.length === 0 || this.battle.defenders.length === 0) {
          this.battle.log.push(this.battle.attackers.length === 0 ? "Defenders win!" : "Attackers win!");
          this.battle.active = false;
          return;
        }

        // continue next round
        this.battle.phase = 'attack';
      }
    }
  },
  mounted() {
    auth.onAuthStateChanged(u => { this.user = u; });
    db.doc("games/demoGame").onSnapshot(snap => { if (snap.exists) this.map = snap.data().map; });
  }
});
app.mount("#app");
</script>
</body>
</html>
