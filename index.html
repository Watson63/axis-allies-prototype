<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Axis & Allies Prototype</title>
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f2f2f2; }
    #board { 
      display: grid; 
      grid-template-columns: repeat(5, 100px); 
      gap: 8px; 
      padding: 20px; 
      justify-content: center;
    }
    .territory { 
      width: 100px; 
      height: 100px; 
      background: white; 
      border: 2px solid #333; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: flex-start; 
      cursor: pointer; 
      transition: border 0.2s ease;
    }
    .territory.selected {
      border: 3px solid #007bff;
      box-shadow: 0 0 10px rgba(0,0,255,0.5);
    }
    .unit { 
      font-size: 11px; 
      padding: 4px 6px; 
      border-radius: 4px; 
      margin: 3px 0; 
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
<div id="app">
  <div v-if="!user">
    <h2>Login</h2>
    <input v-model="email" placeholder="Email"><br>
    <input v-model="password" type="password" placeholder="Password"><br>
    <button @click="login">Login / Register</button>
  </div>

  <div v-else>
    <h2>Welcome, {{ user.email }}</h2>
    <div id="board">
      <div
        v-for="id in territoryOrder"
        :key="id"
        class="territory"
        :class="{ selected: selected && selected.from === id }"
        @click="handleTerritoryClick(id)"
      >
        <strong>{{ id }}</strong>
        <div 
          v-for="u in map[id]?.units || []" 
          :key="u.id" 
          class="unit"
          :style="{ backgroundColor: u.color || '#999' }"
        >
          {{ u.type }}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL4FGAaOfKPJfEkYGBUZN7dW5_XNfmoww",
  authDomain: "axisandallies-prototype.firebaseapp.com",
  projectId: "axisandallies-prototype",
  storageBucket: "axisandallies-prototype.firebasestorage.app",
  messagingSenderId: "663070828047",
  appId: "1:663070828047:web:9f37c0fc5541ff86d6657a"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ðŸŽ¨ consistent color per user (hashing email)
function colorForUser(email) {
  const colors = ["#fcba03", "#fc0303", "#fc0313", "#2403fc", "#000000", "#1f8f03"];
  let hash = 0;
  for (let i = 0; i < email.length; i++) {
    hash = email.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

const app = Vue.createApp({
  data() {
    return {
      user: null,
      email: '',
      password: '',
      map: {},
      selected: null,
      territoryOrder: ["A", "B", "C", "D", "E"] // fixed layout order
    };
  },
  methods: {
    async login() {
      try {
        await auth.signInWithEmailAndPassword(this.email, this.password);
      } catch (e) {
        await auth.createUserWithEmailAndPassword(this.email, this.password);
      }
    },

    async handleTerritoryClick(id) {
      const ref = db.doc("games/demoGame");
      const snap = await ref.get();
      const data = snap.data();

      if (this.selected) {
        // MOVE PHASE
        const fromId = this.selected.from;
        const unit = this.selected.unit;

        // remove unit from previous territory
        data.map[fromId].units = data.map[fromId].units.filter(u => u.id !== unit.id);

        // add unit to target territory
        data.map[id].units.push(unit);

        this.selected = null;
        await ref.update({ map: data.map });
      } else {
        // SELECT or PLACE PHASE
        const territory = data.map[id];
        const ownUnit = territory.units.find(u => u.owner === this.user.email);

        if (ownUnit) {
          // select an existing unit
          this.selected = { from: id, unit: ownUnit };
        } else {
          // place new unit
          const newUnit = {
            id: Date.now(),
            type: "infantry",
            owner: this.user.email,
            color: colorForUser(this.user.email)
          };
          territory.units.push(newUnit);
          await ref.update({ map: data.map });
        }
      }
    }
  },
  mounted() {
    auth.onAuthStateChanged(u => { this.user = u; });
    db.doc("games/demoGame").onSnapshot(snap => {
      if (snap.exists) this.map = snap.data().map;
    });
  }
});
app.mount("#app");
</script>
</body>
</html>
