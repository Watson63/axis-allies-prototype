<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Axis & Allies Prototype</title>
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f2f2f2; text-align: center; }
    #board { 
      display: grid; 
      grid-template-columns: repeat(5, 100px); 
      gap: 8px; 
      padding: 20px; 
      justify-content: center;
    }
    .territory { 
      width: 100px; 
      height: 100px; 
      background: white; 
      border: 2px solid #333; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: flex-start; 
      cursor: pointer; 
      transition: border 0.2s ease;
    }
    .territory.selected {
      border: 3px solid #007bff;
      box-shadow: 0 0 10px rgba(0,0,255,0.5);
    }
    .unit { 
      font-size: 11px; 
      padding: 4px 6px; 
      border-radius: 4px; 
      margin: 3px 0; 
      color: white;
      font-weight: bold;
    }
    select {
      margin-top: 10px;
      padding: 5px;
      font-size: 14px;
    }
    #log {
      width: 80%;
      margin: 10px auto;
      text-align: left;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div id="app">
  <div v-if="!user">
    <h2>Login</h2>
    <input v-model="email" placeholder="Email"><br>
    <input v-model="password" type="password" placeholder="Password"><br>
    <button @click="login">Login / Register</button>
  </div>

  <div v-else>
    <h2>Welcome, {{ user.email }}</h2>
    <div>
      <label><strong>Select Unit Type:</strong></label><br>
      <select v-model="selectedUnitType">
        <option v-for="type in unitTypes" :key="type" :value="type">
          {{ type }}
        </option>
      </select>
    </div>

    <div id="board">
      <div
        v-for="id in territoryOrder"
        :key="id"
        class="territory"
        :class="{ selected: selected && selected.from === id }"
        @click="handleTerritoryClick(id)"
      >
        <strong>{{ id }}</strong>
        <div 
          v-for="u in map[id]?.units || []" 
          :key="u.id" 
          class="unit"
          :style="{ backgroundColor: u.color || '#999' }"
        >
          {{ u.type }}
        </div>
      </div>
    </div>

    <div id="log">
      <h3>Battle Log</h3>
      <div v-for="(entry, index) in battleLog" :key="index">
        â€¢ {{ entry }}
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL4FGAaOfKPJfEkYGBUZN7dW5_XNfmoww",
  authDomain: "axisandallies-prototype.firebaseapp.com",
  projectId: "axisandallies-prototype",
  storageBucket: "axisandallies-prototype.firebasestorage.app",
  messagingSenderId: "663070828047",
  appId: "1:663070828047:web:9f37c0fc5541ff86d6657a"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ðŸŽ¨ consistent color per user
function colorForUser(email) {
  const colors = ["#fcba03", "#fc0303", "#fc0313", "#2403fc", "#000000", "#1f8f03"];
  let hash = 0;
  for (let i = 0; i < email.length; i++) {
    hash = email.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

// âš”ï¸ combat power thresholds
const HIT_THRESHOLDS = {
  infantry: 2,
  tank: 3,
  artillery: 3,
  fighter: 4,
  bomber: 4
};

function rollDie() {
  return Math.floor(Math.random() * 6) + 1;
}

const app = Vue.createApp({
  data() {
    return {
      user: null,
      email: '',
      password: '',
      map: {},
      selected: null,
      battleLog: [],
      territoryOrder: ["A","B","C","D","E","F","G","H","I","J"],
      unitTypes: ["infantry", "tank", "artillery", "fighter", "bomber"],
      selectedUnitType: "infantry"
    };
  },
  methods: {
    async login() {
      try {
        await auth.signInWithEmailAndPassword(this.email, this.password);
      } catch (e) {
        await auth.createUserWithEmailAndPassword(this.email, this.password);
      }
    },

    // âš”ï¸ Battle resolution
    resolveBattle(attackerUnits, defenderUnits) {
      const attackerHits = attackerUnits.reduce((hits, u) => {
        const roll = rollDie();
        return hits + (roll <= HIT_THRESHOLDS[u.type] ? 1 : 0);
      }, 0);

      const defenderHits = defenderUnits.reduce((hits, u) => {
        const roll = rollDie();
        return hits + (roll <= HIT_THRESHOLDS[u.type] ? 1 : 0);
      }, 0);

      // casualties
      const survivingAttackers = attackerUnits.slice();
      const survivingDefenders = defenderUnits.slice();

      for (let i = 0; i < attackerHits && survivingDefenders.length; i++) {
        survivingDefenders.splice(Math.floor(Math.random() * survivingDefenders.length), 1);
      }

      for (let i = 0; i < defenderHits && survivingAttackers.length; i++) {
        survivingAttackers.splice(Math.floor(Math.random() * survivingAttackers.length), 1);
      }

      const winner = survivingAttackers.length && !survivingDefenders.length ? "attacker" :
                     survivingDefenders.length && !survivingAttackers.length ? "defender" : "draw";

      const summary = `Battle: ${attackerUnits.length} attacking vs ${defenderUnits.length} defending â†’ ${winner.toUpperCase()} wins (A:${survivingAttackers.length} D:${survivingDefenders.length})`;
      this.battleLog.unshift(summary);
      return { winner, survivingAttackers, survivingDefenders };
    },

    async handleTerritoryClick(id) {
      const ref = db.doc("games/demoGame");
      const snap = await ref.get();
      const data = snap.data();

      if (!data.map[id]) data.map[id] = { units: [] };

      if (this.selected) {
        const fromId = this.selected.from;
        const unit = this.selected.unit;
        const target = data.map[id];

        const enemyUnits = target.units.filter(u => u.owner !== this.user.email);

        if (enemyUnits.length > 0) {
          // âš”ï¸ Battle
          const result = this.resolveBattle([unit], enemyUnits);
          if (result.winner === "attacker") {
            target.units = result.survivingAttackers.map(u => ({...u}));
          } else if (result.winner === "defender") {
            target.units = result.survivingDefenders.map(u => ({...u}));
          } else {
            target.units = result.survivingAttackers.concat(result.survivingDefenders);
          }
        } else {
          // just move
          data.map[id].units.push(unit);
        }

        data.map[fromId].units = data.map[fromId].units.filter(u => u.id !== unit.id);
        this.selected = null;
        await ref.update({ map: data.map });
      } else {
        const territory = data.map[id];
        const ownUnit = territory.units.find(u => u.owner === this.user.email);
        if (ownUnit) {
          this.selected = { from: id, unit: ownUnit };
        } else {
          const newUnit = {
            id: Date.now(),
            type: this.selectedUnitType,
            owner: this.user.email,
            color: colorForUser(this.user.email)
          };
          territory.units.push(newUnit);
          await ref.update({ map: data.map });
        }
      }
    },

    async ensureMapInitialized() {
      const ref = db.doc("games/demoGame");
      const snap = await ref.get();
      if (!snap.exists) {
        const newMap = {};
        this.territoryOrder.forEach(id => { newMap[id] = { units: [] }; });
        await ref.set({ map: newMap });
      }
    }
  },
  mounted() {
    auth.onAuthStateChanged(async (u) => {
      this.user = u;
      if (u) await this.ensureMapInitialized();
    });

    db.doc("games/demoGame").onSnapshot(snap => {
      if (snap.exists) this.map = snap.data().map;
    });
  }
});
app.mount("#app");
</script>
</body>
</html>
