<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Axis & Allies Prototype â€” Multi-unit Move Selector</title>

  <!-- Vue + Firebase (compat) -->
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; background: #f2f2f2; text-align: center; }
    #board { display: grid; grid-template-columns: repeat(5, 100px); gap: 8px; padding: 20px; justify-content: center; }
    .territory { width: 100px; height: 100px; background: white; border: 2px solid #333; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; cursor:pointer; transition: border 0.2s; padding:6px; box-sizing:border-box;}
    .territory.selected { border: 3px solid #007bff; box-shadow: 0 0 10px rgba(0,0,255,0.3); }
    .unit { font-size: 11px; padding: 4px 6px; border-radius: 4px; margin: 3px 0; color: white; font-weight: bold; display:inline-block; }
    .small { font-size:12px; color:#444; }
    .controls { margin: 8px 0; }
    .checkbox { transform: scale(1.05); margin-right:6px; }
    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal { width: 760px; max-width:95%; background:#fff; border-radius:8px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.3); text-align:left; }
    .battle-row { display:flex; gap:12px; align-items:flex-start; }
    .side { flex:1; border:1px solid #ddd; padding:8px; border-radius:6px; min-height:120px; max-height:320px; overflow:auto; }
    .dice { display:flex; gap:6px; margin:6px 0; flex-wrap:wrap;}
    .die { width:28px; height:28px; display:flex; align-items:center; justify-content:center; border-radius:4px; background:#eee; font-weight:bold; }
    .btn { padding:8px 10px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-danger { background:#e74c3c; color:#fff; }
    .btn-muted { background: #ddd; color:#333; }
    .unit-row { display:flex; align-items:center; justify-content:space-between; margin:4px 0; }
    .stepper { display:flex; gap:6px; align-items:center; margin-top:6px; }
    .stepper button { padding:4px 8px; }
  </style>
</head>
<body>
<div id="app">
  <div v-if="!user">
    <h2>Login</h2>
    <input v-model="email" placeholder="Email"><br>
    <input v-model="password" type="password" placeholder="Password"><br>
    <button @click="login">Login / Register</button>
  </div>

  <div v-else>
    <h2>Welcome, {{ user.email }}</h2>

    <div class="controls">
      <label class="small"><strong>Select Unit Type to Place:</strong></label><br>
      <select v-model="selectedUnitType">
        <option v-for="type in unitTypes" :key="type" :value="type">{{ type }}</option>
      </select>
    </div>

    <div class="small">
      <div>How-to: Click your source territory to select it. Use the checkboxes to pick specific units or use the stepper to set a count. Then click a destination to move the selected units (or start a battle if enemies are present).</div>
    </div>

    <div id="board">
      <div
        v-for="id in territoryOrder"
        :key="id"
        class="territory"
        :class="{ selected: selected && selected.from === id }"
        @click="handleTerritoryClick(id)"
      >
        <strong>{{ id }}</strong>

        <!-- list units -->
        <div v-for="u in map[id]?.units || []" :key="u.id" style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
          <div style="display:flex; gap:6px; align-items:center;">
            <!-- show checkbox for units only if this territory is selected and it's your unit -->
            <input
              v-if="selected && selected.from === id && u.owner === user.email"
              type="checkbox"
              class="checkbox"
              :value="String(u.id)"
              v-model="selected.selectedUnitIds"
            />
            <div class="unit" :style="{ backgroundColor: u.color || '#999' }">{{ u.type }}</div>
          </div>
          <!-- owner hidden -->
        </div>

        <!-- selection controls -->
        <div v-if="selected && selected.from === id" style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
          <div style="display:flex; gap:6px;">
            <button class="btn btn-muted" @click.stop="selectAllFrom(id)">Select All</button>
            <button class="btn btn-muted" @click.stop="cancelSelection()">Cancel</button>
          </div>

          <!-- stepper to choose count to move -->
          <div class="stepper">
            <button class="btn" @click.stop="decrementMoveCount()">-</button>
            <div class="small">Move count: <strong>{{ selected.moveCount }}</strong></div>
            <button class="btn" @click.stop="incrementMoveCount(id)">+</button>
            <button class="btn btn-primary" @click.stop="applyMoveCountSelection(id)">Use Count</button>
          </div>
        </div>
      </div>
    </div>

    <div id="log" style="width:80%; margin:14px auto;">
      <h4 class="small">Battle Summary Log</h4>
      <div v-for="(e,i) in battleSummaryLog" :key="i" class="small">â€¢ {{ e }}</div>
    </div>
  </div>

  <!-- Battle Modal (unchanged from your structure) -->
  <div v-if="activeBattle" class="modal-backdrop">
    <div class="modal">
      <h3>Battle at {{ activeBattle.territory }}</h3>
      <div class="small">Attacker: {{ activeBattle.attackerEmail }} â€” Defender: {{ activeBattle.defenderEmail }}</div>

      <div style="margin-top:8px">
        <div class="battle-row">
          <!-- Attacker -->
          <div class="side">
            <h4>Attacker Units</h4>
            <div v-for="u in activeBattle.attackerUnits" :key="u.id" class="unit-row">
              <div style="display:flex; align-items:center; gap:8px">
                <div class="unit" :style="{ backgroundColor: u.color }">{{ u.type }}</div>
                <div class="small">{{ u.id }}</div>
              </div>
              <div v-if="phase === 'chooseAttackerCasualties'">
                <input type="checkbox" class="checkbox" :value="String(u.id)" v-model="selectedCasualtiesAttacker" />
              </div>
            </div>

            <div class="small" style="margin-top:8px;">Attacker Rolls:</div>
            <div class="dice">
              <div v-for="(d,i) in activeBattle.attackerRolls || []" :key="'a'+i" class="die">{{ d }}</div>
            </div>

            <div style="margin-top:8px;">
              <button class="btn btn-primary" :disabled="!canRoll('attacker')" @click="rollDice('attacker')">Roll Dice (Attacker)</button>
            </div>
          </div>

          <!-- Defender -->
          <div class="side">
            <h4>Defender Units</h4>
            <div v-for="u in activeBattle.defenderUnits" :key="u.id" class="unit-row">
              <div style="display:flex; align-items:center; gap:8px">
                <div class="unit" :style="{ backgroundColor: u.color }">{{ u.type }}</div>
                <div class="small">{{ u.id }}</div>
              </div>
              <div v-if="phase === 'chooseDefenderCasualties'">
                <input type="checkbox" class="checkbox" :value="String(u.id)" v-model="selectedCasualtiesDefender" />
              </div>
            </div>

            <div class="small" style="margin-top:8px;">Defender Rolls:</div>
            <div class="dice">
              <div v-for="(d,i) in activeBattle.defenderRolls || []" :key="'d'+i" class="die">{{ d }}</div>
            </div>

            <div style="margin-top:8px;">
              <button class="btn btn-primary" :disabled="!canRoll('defender')" @click="rollDice('defender')">Roll Dice (Defender)</button>
            </div>
          </div>
        </div>

        <!-- round info & casualty UI -->
        <div style="margin-top:12px;">
          <div class="small"><strong>Round:</strong> {{ activeBattle.round }}</div>
          <div class="small"><strong>Last Hits â€” A:</strong> {{ activeBattle.lastAttackerHits || 0 }} â€” <strong>D:</strong> {{ activeBattle.lastDefenderHits || 0 }}</div>

          <div v-if="phase === 'chooseDefenderCasualties'" style="margin-top:8px;">
            <div class="small">Defender: select <strong>{{ activeBattle.lastAttackerHits }}</strong> unit(s) to remove</div>
            <button class="btn btn-primary" :disabled="selectedCasualtiesDefender.length !== activeBattle.lastAttackerHits" @click="applyDefenderCasualties()">Confirm</button>
          </div>

          <div v-if="phase === 'chooseAttackerCasualties'" style="margin-top:8px;">
            <div class="small">Attacker: select <strong>{{ activeBattle.lastDefenderHits }}</strong> unit(s) to remove</div>
            <button class="btn btn-primary" :disabled="selectedCasualtiesAttacker.length !== activeBattle.lastDefenderHits" @click="applyAttackerCasualties()">Confirm</button>
          </div>

          <div v-if="phase === 'resolved'" style="margin-top:10px;">
            <div class="small"><strong>Battle finished â€” winner:</strong> {{ activeBattle.winner }}</div>
            <button class="btn btn-primary" @click="finishBattle()">Close & Apply Results</button>
          </div>

          <div style="margin-top:8px;">
            <button class="btn btn-danger" @click="abortBattle()" v-if="canAbort">Abort Battle</button>
          </div>
        </div>

        <div style="margin-top:8px;">
          <h4 class="small">Battle Log</h4>
          <div v-for="(l,i) in activeBattle.log || []" :key="i" class="small">â€¢ {{ l }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAL4FGAaOfKPJfEkYGBUZN7dW5_XNfmoww",
    authDomain: "axisandallies-prototype.firebaseapp.com",
    projectId: "axisandallies-prototype",
    storageBucket: "axisandallies-prototype.firebasestorage.app",
    messagingSenderId: "663070828047",
    appId: "1:663070828047:web:9f37c0fc5541ff86d6657a"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // color function unchanged
  function colorForUser(email) {
    const colors = ["#fcba03", "#fc0303", "#fc0313", "#2403fc", "#000000", "#1f8f03"];
    let hash = 0;
    for (let i = 0; i < email.length; i++) hash = email.charCodeAt(i) + ((hash << 5) - hash);
    return colors[Math.abs(hash) % colors.length];
  }

  // roll helper
  function rollDie() { return Math.floor(Math.random()*6)+1; }

  // thresholds: attacker vs defender per unit type
  const ATTACK_THRESHOLDS = { infantry: 1, tank: 3, artillery: 2, fighter: 3, bomber: 4 };
  const DEFEND_THRESHOLDS = { infantry: 2, tank: 3, artillery: 2, fighter: 4, bomber: 4 };

  const app = Vue.createApp({
    data() {
  return {
    user: null,
    email: '',
    password: '',
    map: {},
    selected: null,
    territoryOrder: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"],
    battle: null,
    diceRolls: [],
    message: ""
  };
},
methods: {
  // âš”ï¸ Trigger a battle if clicking enemy-occupied territory
  async handleTerritoryClick(id) {
    const ref = db.doc("games/demoGame");
    const snap = await ref.get();
    const data = snap.data();
    const territory = data.map[id];

    if (this.selected) {
      const fromId = this.selected.from;
      const unit = this.selected.unit;
      const fromTerritory = data.map[fromId];

      const enemyHere = territory.units.some(u => u.owner !== this.user.email);
      if (enemyHere) {
        // Start battle mode
        this.battle = {
          attacker: this.user.email,
          defender: territory.units[0].owner,
          attackingUnits: [unit],
          defendingUnits: JSON.parse(JSON.stringify(territory.units)),
          territoryId: id,
          round: 1
        };
        this.selected = null;
        this.message = "Battle started in " + id + "!";
      } else {
        // Regular move
        fromTerritory.units = fromTerritory.units.filter(u => u.id !== unit.id);
        territory.units.push(unit);
        this.selected = null;
        await ref.update({ map: data.map });
      }
    } else {
      const unit = territory.units.find(u => u.owner === this.user.email);
      if (unit) this.selected = { from: id, unit };
      else {
        const newUnit = {
          id: Date.now(),
          type: "infantry",
          owner: this.user.email,
          color: colorForUser(this.user.email)
        };
        territory.units.push(newUnit);
        await ref.update({ map: data.map });
      }
    }
  },

  // ðŸŽ² Roll dice animation helper
  rollAnimation(count) {
    return Array.from({ length: count }, () => Math.floor(Math.random() * 6) + 1);
  },

  // ðŸª– Attacker rolls
  attackerRoll() {
    if (!this.battle) return;
    const rolls = this.rollAnimation(this.battle.attackingUnits.length);
    this.diceRolls = rolls;
    const hits = rolls.filter(r => r === 1).length; // infantry hits on 1
    this.battle.defendingUnits.forEach((u, i) => {
      if (hits > i) u.isCasualty = true;
    });
    this.message = `Attacker rolled: ${rolls.join(", ")} â€” ${hits} hits!`;
  },

  // ðŸ›¡ï¸ Defender rolls (including casualties firing back once)
  defenderRoll() {
    if (!this.battle) return;
    const defendersAbleToFire = this.battle.defendingUnits.filter(u => !u.firedBack);
    const rolls = this.rollAnimation(defendersAbleToFire.length);
    this.diceRolls = rolls;
    const hits = rolls.filter(r => r <= 2).length; // infantry hits on 2 or less
    this.message = `Defender rolled: ${rolls.join(", ")} â€” ${hits} hits!`;

    // Mark casualties as having fired back
    this.battle.defendingUnits.forEach(u => {
      if (u.isCasualty) u.firedBack = true;
    });

    // Apply hits to attackers
    this.battle.attackingUnits.forEach((u, i) => {
      if (hits > i) u.isCasualty = true;
    });

    // Remove all units that have fired back and are casualties
    this.battle.defendingUnits = this.battle.defendingUnits.filter(
      u => !u.isCasualty || !u.firedBack
    );
    this.battle.attackingUnits = this.battle.attackingUnits.filter(u => !u.isCasualty);

    // Next round or end battle
    if (this.battle.defendingUnits.length === 0 || this.battle.attackingUnits.length === 0) {
      this.endBattle();
    } else {
      this.battle.round++;
      this.message += ` | Round ${this.battle.round} begins.`;
    }
  },

  async endBattle() {
    const ref = db.doc("games/demoGame");
    const snap = await ref.get();
    const data = snap.data();
    const territory = data.map[this.battle.territoryId];

    if (this.battle.attackingUnits.length > 0) {
      // attacker wins â†’ replace defenders
      territory.units = this.battle.attackingUnits;
    } else {
      // defender holds
      territory.units = this.battle.defendingUnits;
    }

    await ref.update({ map: data.map });
    this.message = "Battle over!";
    this.battle = null;
  }
}
  }
    },

    mounted() {
      auth.onAuthStateChanged(async (u) => {
        this.user = u;
        if (u) await this.ensureMapInitialized();
      });

      db.doc("games/demoGame").onSnapshot(snap => {
        if (!snap.exists) return;
        const data = snap.data();
        this.map = data.map || {};
        this.activeBattle = data.activeBattle || null;

        if (this.activeBattle) {
          this.activeBattle.attackerUnits = (this.activeBattle.attackerUnits || []).map(u => ({...u, id: String(u.id)}));
          this.activeBattle.defenderUnits = (this.activeBattle.defenderUnits || []).map(u => ({...u, id: String(u.id)}));
        }
      });
    }
  });

  app.mount('#app');

  // helpers
  function rollDie() { return Math.floor(Math.random()*6)+1; }
</script>
</body>
</html>
