<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Axis & Allies Prototype — Simultaneous Fire</title>

  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: sans-serif; background: #f2f2f2; text-align: center; margin:0;}
    #board { display:grid; grid-template-columns:repeat(5,100px); gap:8px; padding:20px; justify-content:center;}
    .territory {width:100px; height:100px; background:white; border:2px solid #333; border-radius:4px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; cursor:pointer; transition:border 0.2s; padding:6px; box-sizing:border-box;}
    .territory.selected {border:3px solid #007bff; box-shadow:0 0 10px rgba(0,0,255,0.3);}
    .unit {font-size:11px; padding:4px 6px; border-radius:4px; margin:3px 0; color:white; font-weight:bold; display:inline-block;}
    .small {font-size:12px; color:#444;}
    .btn {padding:6px 10px; border:none; border-radius:5px; cursor:pointer;}
    .btn-primary {background:#007bff; color:white;}
    .btn-danger {background:#e74c3c; color:white;}
    .btn-muted {background:#ddd; color:#333;}
    .modal-backdrop {position:fixed; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;}
    .modal {width:750px; max-width:95%; background:white; border-radius:8px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,0.3);}
    .battle-row {display:flex; gap:12px;}
    .side {flex:1; border:1px solid #ddd; padding:8px; border-radius:6px;}
    .dice {display:flex; gap:6px; flex-wrap:wrap;}
    .die {width:28px; height:28px; display:flex; align-items:center; justify-content:center; background:#eee; border-radius:4px;}
  </style>
</head>
<body>
<div id="app">
  <div v-if="!user">
    <h2>Login</h2>
    <input v-model="email" placeholder="Email"><br>
    <input v-model="password" type="password" placeholder="Password"><br>
    <button @click="login">Login / Register</button>
  </div>

  <div v-else>
    <h2>Welcome, {{ user.email }}</h2>
    <div id="board">
      <div v-for="id in territoryOrder" :key="id" class="territory"
           :class="{selected:selected && selected.from===id}"
           @click="handleTerritoryClick(id)">
        <strong>{{ id }}</strong>
        <div v-for="u in map[id]?.units || []" :key="u.id" style="width:100%;display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;align-items:center;gap:6px;">
            <input v-if="selected && selected.from===id && u.owner===user.email"
                   type="checkbox" class="checkbox" :value="String(u.id)" v-model="selected.selectedUnitIds"/>
            <div class="unit" :style="{backgroundColor:u.color}">{{u.type}}</div>
          </div>
        </div>
      </div>
    </div>

    <div v-if="activeBattle" class="modal-backdrop">
      <div class="modal">
        <h3>Battle at {{activeBattle.territory}}</h3>
        <p>Round {{activeBattle.round}}</p>

        <div class="battle-row">
          <div class="side">
            <h4>Attacker</h4>
            <div v-for="u in activeBattle.attackerUnits" :key="u.id">
              <div class="unit" :style="{backgroundColor:u.color}">{{u.type}}</div>
              <span v-if="phase==='chooseAttackerCasualties'">
                <input type="checkbox" :value="String(u.id)" v-model="selectedCasualtiesAttacker">
              </span>
            </div>
            <button class="btn btn-primary" :disabled="!canRoll('attacker')" @click="rollDice('attacker')">Roll Attacker</button>
            <div class="dice"><div v-for="(d,i) in activeBattle.attackerRolls" :key="'a'+i" class="die">{{d}}</div></div>
          </div>

          <div class="side">
            <h4>Defender</h4>
            <div v-for="u in activeBattle.defenderUnits" :key="u.id">
              <div class="unit" :style="{backgroundColor:u.color}">{{u.type}}</div>
              <span v-if="phase==='chooseDefenderCasualties'">
                <input type="checkbox" :value="String(u.id)" v-model="selectedCasualtiesDefender">
              </span>
            </div>
            <button class="btn btn-primary" :disabled="!canRoll('defender')" @click="rollDice('defender')">Roll Defender</button>
            <div class="dice"><div v-for="(d,i) in activeBattle.defenderRolls" :key="'d'+i" class="die">{{d}}</div></div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <div v-if="phase==='chooseDefenderCasualties'">
            Defender: select {{activeBattle.lastAttackerHits}} unit(s) to remove
            <button class="btn btn-primary"
                    :disabled="selectedCasualtiesDefender.length!==activeBattle.lastAttackerHits"
                    @click="applyDefenderCasualties">Confirm</button>
          </div>
          <div v-if="phase==='chooseAttackerCasualties'">
            Attacker: select {{activeBattle.lastDefenderHits}} unit(s) to remove
            <button class="btn btn-primary"
                    :disabled="selectedCasualtiesAttacker.length!==activeBattle.lastDefenderHits"
                    @click="applyAttackerCasualties">Confirm</button>
          </div>
          <div v-if="phase==='resolved'">
            <p>Winner: {{activeBattle.winner}}</p>
            <button class="btn btn-primary" @click="finishBattle">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAL4FGAaOfKPJfEkYGBUZN7dW5_XNfmoww",
  authDomain: "axisandallies-prototype.firebaseapp.com",
  projectId: "axisandallies-prototype",
  storageBucket: "axisandallies-prototype.firebasestorage.app",
  messagingSenderId: "663070828047",
  appId: "1:663070828047:web:9f37c0fc5541ff86d6657a"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

function rollDie(){return Math.floor(Math.random()*6)+1;}
const ATTACK_THRESHOLDS={infantry:1,tank:3,artillery:3,fighter:4,bomber:4};
const DEFEND_THRESHOLDS={infantry:2,tank:3,artillery:3,fighter:4,bomber:4};
function colorForUser(email){
  const colors=["#fcba03","#fc0303","#2403fc","#000","#1f8f03"];
  let hash=0;for(let i=0;i<email.length;i++)hash=email.charCodeAt(i)+((hash<<5)-hash);
  return colors[Math.abs(hash)%colors.length];
}

const app=Vue.createApp({
  data(){return{
    user:null,email:'',password:'',
    map:{},territoryOrder:["A","B","C","D","E","F","G","H","I","J"],
    selected:null,activeBattle:null,
    selectedCasualtiesDefender:[],selectedCasualtiesAttacker:[]
  }},
  computed:{phase(){return this.activeBattle?this.activeBattle.phase:null;}},
  methods:{
    async login(){try{await auth.signInWithEmailAndPassword(this.email,this.password);}
      catch(e){await auth.createUserWithEmailAndPassword(this.email,this.password);}
    },
    async ensureMapInitialized(){
      const ref=db.doc("games/demoGame");
      const snap=await ref.get();
      if(!snap.exists){
        const m={};this.territoryOrder.forEach(t=>m[t]={units:[]});
        await ref.set({map:m});
      }
    },
    async handleTerritoryClick(id){
      const ref=db.doc("games/demoGame");
      const snap=await ref.get();const data=snap.data()||{map:{}};
      if(!data.map[id])data.map[id]={units:[]};
      if(!this.selected){
        const own=(data.map[id].units||[]).filter(u=>u.owner===this.user.email);
        if(own.length){this.selected={from:id,selectedUnitIds:[]};return;}
        const u={id:Date.now(),type:"infantry",owner:this.user.email,color:colorForUser(this.user.email)};
        data.map[id].units.push(u);await ref.update({map:data.map});return;
      }
      if(this.selected.from===id){this.selected=null;return;}
      const from=this.selected.from;const fromUnits=data.map[from].units||[];
      const moveIds=this.selected.selectedUnitIds;
      const moving=fromUnits.filter(u=>moveIds.includes(String(u.id)));
      data.map[from].units=fromUnits.filter(u=>!moveIds.includes(String(u.id)));
      const dest=data.map[id].units||[];
      const enemies=dest.filter(u=>u.owner!==this.user.email);
      if(enemies.length){
        const battle={
          territory:id,attackerEmail:this.user.email,defenderEmail:enemies[0].owner,
          attackerUnits:moving,defenderUnits:dest,
          round:1,phase:'awaitingAttackerRoll',
          attackerRolls:[],defenderRolls:[],lastAttackerHits:0,lastDefenderHits:0,log:[]
        };
        data.activeBattle=battle;
        await ref.update({map:data.map,activeBattle:battle});
        this.selected=null;return;
      }
      data.map[id].units=dest.concat(moving);
      await ref.update({map:data.map});
      this.selected=null;
    },
    canRoll(side){
      if(!this.activeBattle)return false;
      if(side==='attacker'&&this.phase==='awaitingAttackerRoll')return this.user.email===this.activeBattle.attackerEmail;
      if(side==='defender'&&this.phase==='awaitingDefenderRoll')return this.user.email===this.activeBattle.defenderEmail;
      return false;
    },
    async rollDice(side){
      const ref=db.doc("games/demoGame");const snap=await ref.get();
      const data=snap.data();const b=data.activeBattle;if(!b)return;
      if(side==='attacker'&&b.phase==='awaitingAttackerRoll'){
        const rolls=b.attackerUnits.map(()=>rollDie());
        let hits=0;for(let i=0;i<rolls.length;i++){if(rolls[i]<=ATTACK_THRESHOLDS[b.attackerUnits[i].type])hits++;}
        b.attackerRolls=rolls;b.lastAttackerHits=hits;
        b.log.push(`Attacker rolled ${rolls.join(',')} → ${hits} hits`);
        b.phase='awaitingDefenderRoll';
      }else if(side==='defender'&&b.phase==='awaitingDefenderRoll'){
        const rolls=b.defenderUnits.map(()=>rollDie());
        let hits=0;for(let i=0;i<rolls.length;i++){if(rolls[i]<=DEFEND_THRESHOLDS[b.defenderUnits[i].type])hits++;}
        b.defenderRolls=rolls;b.lastDefenderHits=hits;
        b.log.push(`Defender rolled ${rolls.join(',')} → ${hits} hits`);
        // both sides rolled => choose casualties
        if(b.lastAttackerHits>0)b.phase='chooseDefenderCasualties';
        else if(b.lastDefenderHits>0)b.phase='chooseAttackerCasualties';
        else{b.round++;b.phase='awaitingAttackerRoll';}
      }
      await ref.update({activeBattle:b});
    },
    async applyDefenderCasualties(){
      const ref=db.doc("games/demoGame");const snap=await ref.get();
      const data=snap.data();const b=data.activeBattle;const hits=b.lastAttackerHits;
      b.defenderUnits=b.defenderUnits.filter(u=>!this.selectedCasualtiesDefender.includes(String(u.id)));
      this.selectedCasualtiesDefender=[];
      if(b.defenderUnits.length===0){b.winner='attacker';b.phase='resolved';}
      else if(b.lastDefenderHits>0){b.phase='chooseAttackerCasualties';}
      else{b.round++;b.phase='awaitingAttackerRoll';}
      await ref.update({activeBattle:b});
    },
    async applyAttackerCasualties(){
      const ref=db.doc("games/demoGame");const snap=await ref.get();
      const data=snap.data();const b=data.activeBattle;const hits=b.lastDefenderHits;
      b.attackerUnits=b.attackerUnits.filter(u=>!this.selectedCasualtiesAttacker.includes(String(u.id)));
      this.selectedCasualtiesAttacker=[];
      if(b.attackerUnits.length===0){b.winner='defender';b.phase='resolved';}
      else{b.round++;b.phase='awaitingAttackerRoll';}
      await ref.update({activeBattle:b});
    },
    async finishBattle(){
      const ref=db.doc("games/demoGame");const snap=await ref.get();
      const data=snap.data();const b=data.activeBattle;
      if(b.winner==='attacker')data.map[b.territory].units=b.attackerUnits;
      else if(b.winner==='defender')data.map[b.territory].units=b.defenderUnits;
      await ref.update({map:data.map,activeBattle:firebase.firestore.FieldValue.delete()});
    }
  },
  mounted(){
    auth.onAuthStateChanged(async u=>{this.user=u;if(u)await this.ensureMapInitialized();});
    db.doc("games/demoGame").onSnapshot(snap=>{
      const d=snap.data();if(!d)return;this.map=d.map||{};this.activeBattle=d.activeBattle||null;
    });
  }
});
app.mount('#app');
</script>
</body>
</html>
